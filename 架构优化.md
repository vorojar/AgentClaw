# AgentClaw 架构优化：极简工具 + 按需 Skill 加载

## 设计理念

借鉴 Pi Agent 的极简主义：**只保留最少的原子工具，其余能力通过 Skill 按需加载**。
Skill = SKILL.md（指令）+ scripts/（预写脚本），LLM 通过 shell 调用脚本完成任务。

## 工具分层

### 第一层：核心工具（永远加载，4 个）

| 工具 | 原因 |
|---|---|
| `shell` | 唯一命令执行入口 |
| `file_read` | 结构化读文件 |
| `file_write` | 结构化写文件 |
| `ask_user` | 需要 gateway 的 promptUser 回调 |

### 第二层：条件工具（按配置加载，5 个）

| 工具 | 加载条件 | 原因 |
|---|---|---|
| `send_file` | gateway 模式 | 需要 context.sendFile 回调 |
| `set_reminder` | scheduler 可用 | 需要 context.notifyUser + scheduler |
| `schedule` | scheduler 可用 | 需要 context.scheduler |
| `remember` | memoryStore 可用 | 需要 context.saveMemory |
| `plan_task` | planner 可用 | 需要 context.planner |

### 第三层：Skill 化（按需加载，9 个）

| 原工具 | Skill 目录 | 实现方式 |
|---|---|---|
| `python` | `skills/python-exec/` | SKILL.md only — 教 LLM 用 `shell("python3 ...")` |
| `http_request` | `skills/http-request/` | SKILL.md only — 教 LLM 用 `curl` |
| `web_fetch` | `skills/web-fetch/` | SKILL.md only — 教 LLM 用 `curl` + 管道处理 |
| `create_skill` | `skills/create-skill/` | SKILL.md only — 教 LLM 用 `file_write` 创建 SKILL.md |
| `web_search` | `skills/web-search/` | SKILL.md + `scripts/search.py`（调 Serper API） |
| `comfyui` | `skills/comfyui/` | SKILL.md + `scripts/comfyui.py`（调 ComfyUI API） |
| `browser` | `skills/browser/` | SKILL.md + `scripts/browser.mjs`（puppeteer CDP） |
| `google_calendar` | `skills/google-calendar/` | SKILL.md + `scripts/gcal.py`（OAuth + Calendar API） |
| `google_tasks` | `skills/google-tasks/` | SKILL.md + `scripts/gtasks.py`（OAuth + Tasks API） |

## Token 开销对比

```
优化前（18 tools 全加载）:    ~5,000 tokens/请求
优化后（4 core + 0~5 条件）:  ~1,000~1,500 tokens/请求
命中 skill 时:                +200~500 tokens（仅按需）
```

预期节省：**60-80%** 的工具定义 token 开销。

## 代码修改

### 1. `packages/tools/src/builtin/index.ts`

```typescript
export interface BuiltinToolsOptions {
  gateway?: boolean;   // send_file, set_reminder, schedule
  memory?: boolean;    // remember
  planner?: boolean;   // plan_task
}

export function createBuiltinTools(options?: BuiltinToolsOptions): Tool[] {
  const tools: Tool[] = [shellTool, fileReadTool, fileWriteTool, askUserTool];

  if (options?.gateway) {
    tools.push(sendFileTool, setReminderTool, scheduleTool);
  }
  if (options?.memory) {
    tools.push(rememberTool);
  }
  if (options?.planner) {
    tools.push(planTaskTool);
  }

  return tools;
}
```

### 2. `packages/gateway/src/bootstrap.ts`

```typescript
const builtinTools = createBuiltinTools({
  gateway: true,              // gateway 模式，启用 send_file 等
  memory: true,               // 总是有 memoryStore
  planner: !!process.env.ENABLE_PLANNER,  // 按需
});
```

### 3. Skill 目录结构

每个 skill 遵循统一结构：

```
skills/<name>/
├── SKILL.md          # 必需：frontmatter(triggers) + 指令
├── REFERENCE.md      # 可选：详细参考文档
└── scripts/          # 可选：预写脚本
    └── *.py / *.mjs
```

## 实施清单

1. 创建 9 个 skill 目录和文件
2. 修改 `createBuiltinTools()` 支持分层加载
3. 修改 `bootstrap.ts` 传入配置
4. 移除不再需要的 tool 文件 import/export（保留文件不删，以备回退）
5. 构建验证
